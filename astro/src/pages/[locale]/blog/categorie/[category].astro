---
import PageLayout from '../../../../layouts/PageLayout.astro';
import Container from '../../../../components/ui/Container.astro';
import Card from '../../../../components/ui/Card.astro';
import StrapiImage from '../../../../components/ui/StrapiImage.astro';
import { fetchCollection } from '../../../../lib/strapi';
import { LOCALES, t, getLocalePath } from '../../../../lib/i18n';
import type { Locale } from '../../../../lib/i18n';
import type { BlogPost, BlogCategory } from '../../../../lib/types';

export async function getStaticPaths() {
  const paths = [];
  for (const locale of LOCALES) {
    try {
      const categories = await fetchCollection<BlogCategory>('blog-categories', locale);
      for (const cat of categories) {
        const posts = await fetchCollection<BlogPost>('blog-posts', locale, {
          'filters[category][slug][$eq]': cat.slug,
        });
        paths.push({ params: { locale, category: cat.slug }, props: { category: cat, posts } });
      }
    } catch {
      // Strapi not available
    }
  }
  return paths;
}

const locale = Astro.params.locale as Locale;
const { category, posts = [] } = Astro.props;
---
<PageLayout locale={locale} title={`${category?.name || 'Category'} | Blog`}>
  <section class="py-16 md:py-24">
    <Container>
      <a href={getLocalePath(locale, '/blog')} class="text-sm text-primary-500 hover:text-primary-600 mb-4 inline-block">&larr; {t(locale, 'blog.backToList')}</a>
      <h1 class="text-4xl font-bold text-neutral-900 mb-12">{category?.name || 'Category'}</h1>
      {posts.length > 0 ? (
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {posts.map((post: BlogPost) => (
            <a href={getLocalePath(locale, `/blog/${post.slug}`)} class="group">
              <Card>
                {post.featuredImage && (
                  <StrapiImage image={post.featuredImage} class="w-full h-48 object-cover rounded-lg mb-4" />
                )}
                <h2 class="text-lg font-semibold text-neutral-900 group-hover:text-primary-500 transition-colors mb-2">
                  {post.title}
                </h2>
                {post.excerpt && <p class="text-sm text-neutral-600 line-clamp-2">{post.excerpt}</p>}
              </Card>
            </a>
          ))}
        </div>
      ) : (
        <p class="text-neutral-600 text-center py-12">Aucun article dans cette cat√©gorie.</p>
      )}
    </Container>
  </section>
</PageLayout>
